{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add Quiz</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body class="bg-light">

<div class="d-flex justify-content-between align-items-center p-3 bg-white shadow-sm">
  <a href="{% url 'instructor_dashboard' %}" class="text-decoration-none text-dark">
    <h3 class="m-0 fw-bold">Bildung</h3>
  </a>

  <div class="dropdown">
    <button class="btn rounded-circle shadow"
            style="background:gray;color:white;width:45px;height:45px;"
            data-bs-toggle="dropdown">
      {{ request.user.username|first|upper }}
    </button>

    <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="{% url 'instructor_profile_view' %}">Profile</a></li>
                <li><a class="dropdown-item" href="{% url 'instructor:add_course' %}">Create New Course</a></li>
                <li><a class="dropdown-item" href="{% url 'instructor:students_list' %}">My Students</a></li>
                <li><a class="dropdown-item" href="{% url 'instructor:calendar_view' %}">My Schedules</a></li>
                <li><a class="dropdown-item" href="{% url 'instructor_notifications' %}">Notifications</a></li>
                <li><a class="dropdown-item" href="#">Earnings & Payments</a></li>
                <li><a class="dropdown-item" href="#">Help & Support</a></li>
                <li><a class="dropdown-item" href="{% url 'instructor_account_settings' %}">Account Settings</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="{% url 'logout_view' %}">Logout</a></li>
    </ul>
  </div>
</div>

<input type="hidden" id="csrfToken" value="{{ csrf_token }}">

<div class="container py-4">

  <h3>Add Quiz</h3>

  <label class="form-label">Quiz Title</label>
  <input id="quizTitle" class="form-control mb-3">

  <hr>

  <div id="ragSection" class="d-none">
    <h5>AI Generated Questions</h5>

    <div class="mb-3">
  <label for="question_source" class="form-label">
    <strong>Question Source</strong>
  </label>

  <select id="question_source" class="form-select">
    <option value="both">PDFs + Videos</option>
    <option value="pdf">PDFs only</option>
    <option value="video">Videos only</option>
  </select>

    <small class="text-muted">
      Choose where questions should be generated from.
    </small>
  </div>


    <div class="mb-3">
      <label class="form-label fw-bold">Number of Questions</label>
      <input type="number" id="questionCount"
             class="form-control" min="1" max="50" value="5">
    </div>

    <button class="btn btn-success mb-2" onclick="openScopeModal()">
      üöÄ Generate Questions
    </button>


    <p id="aiStatus" class="text-muted"></p>
  </div>

  <div id="questionsSection" class="mt-4 d-none">
    <h5> Manual Questions</h5>

    <button class="btn btn-outline-primary mb-3" onclick="addManualQuestion()">
      ‚ûï Add Question
    </button>

    <div id="aiOutput"></div>
  </div>

  <hr>

  <button class="btn btn-primary" onclick="saveQuiz()">Save Quiz</button>

  <a class="btn btn-outline-secondary ms-2"
     href="{% url 'quiz_preview' course_id quiz_id %}">
    üëÄ Preview Quiz
  </a>

</div>

<div class="modal fade" id="quizModeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Choose Quiz Creation Mode</h5>
      </div>
      <div class="modal-body d-grid gap-3">
        <button class="btn btn-outline-primary" onclick="selectQuizMode('manual')">
          ‚úçÔ∏è Create Manually
        </button>
        <button class="btn btn-outline-success" onclick="selectQuizMode('auto')">
          ü§ñ Auto-generate using AI
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="quizScopeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Lecture Accessibility</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <select id="quizScope" class="form-select">
          <option value="all_before">All lectures before this quiz</option>
          <option value="since_last_quiz">Lectures since last quiz</option>
        </select>

        <button class="btn btn-primary w-100 mt-3"
                onclick="confirmScopeAndGenerate()">
          Continue
        </button>
      </div>

    </div>
  </div>
</div>

<script>
const COURSE_ID = "{{ course_id }}";
const QUIZ_ID = "{{ quiz_id }}";
const QUIZ_BLOCK = {{ quiz_block|default:"null"|safe }};

let QUIZ_MODE = QUIZ_BLOCK?.quiz_mode || null;
let QUIZ_SCOPE = QUIZ_BLOCK?.scope || "all_before";
let QUESTION_SOURCE = QUIZ_BLOCK?.source || "both";
let ALL_QUESTIONS = [];

document.addEventListener("DOMContentLoaded", () => {
  {% if quiz.title %}
    quizTitle.value = "{{ quiz.title|escapejs }}";
  {% endif %}

  const sourceSelect = document.getElementById("question_source");
  if (sourceSelect) {
    sourceSelect.value = QUESTION_SOURCE;
  }
 
  if (!QUIZ_MODE) {
    new bootstrap.Modal(quizModeModal, { backdrop: "static" }).show();
  } else {
    applyQuizMode(QUIZ_MODE);
  }
});

function selectQuizMode(mode) {
  QUIZ_MODE = mode;
  applyQuizMode(mode);
  bootstrap.Modal.getInstance(quizModeModal)?.hide();
}

function applyQuizMode(mode) {
  ragSection.classList.toggle("d-none", mode !== "auto");
  questionsSection.classList.remove("d-none");
}

function addManualQuestion() {
  ALL_QUESTIONS.push({
    question: "",
    options: { A: "", B: "", C: "", D: "" },
    correct_answer: "A",
    source: "manual"
  });
  renderAllQuestions();
}


function openScopeModal() {
  new bootstrap.Modal(quizScopeModal).show();
}

function confirmScopeAndGenerate() {
  QUIZ_SCOPE = quizScope.value;
  bootstrap.Modal.getInstance(quizScopeModal)?.hide();
  generateAIQuestions();
}

function generateAIQuestions() {
  let count = parseInt(questionCount.value) || 5;

  QUESTION_SOURCE = document.getElementById("question_source").value;

  aiStatus.innerText = "‚è≥ Generating questions...";
  fetch(
    `http://127.0.0.1:8001/quiz/${QUIZ_ID}/generate` +
    `?scope=${QUIZ_SCOPE}&source=${QUESTION_SOURCE}&mode=auto`,
   {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ num_questions: count })
   })
  .then(res => res.json())
  .then(data => {
    if (!Array.isArray(data.questions) || data.questions.length === 0) {
      aiStatus.innerText = "‚ö†Ô∏è No questions generated";
      return;
    }
    data.questions.forEach(q => {
      q.source = "ai";
      ALL_QUESTIONS.push(q);
    });
    renderAllQuestions();
    aiStatus.innerText = `‚úÖ ${data.questions.length} questions generated`;
  })
  .catch(() => aiStatus.innerText = "‚ùå Failed to generate questions");
}


function renderAllQuestions() {
  aiOutput.innerHTML = "";

  ALL_QUESTIONS.forEach((q, i) => {
    aiOutput.innerHTML += `
      <div class="border rounded p-3 mb-3 bg-white">
        <div class="d-flex justify-content-between">
          <strong>Q${i + 1} (${q.source})</strong>
          <button class="btn btn-sm btn-danger"
            onclick="ALL_QUESTIONS.splice(${i},1);renderAllQuestions()">üóë</button>
        </div>

        <textarea class="form-control mt-2"
          onchange="ALL_QUESTIONS[${i}].question=this.value">${q.question}</textarea>

        ${["A","B","C","D"].map(l => `
          <div class="input-group mt-1">
            <span class="input-group-text">${l}</span>
            <input class="form-control" value="${q.options[l]}"
              onchange="ALL_QUESTIONS[${i}].options['${l}']=this.value">
            <span class="input-group-text">
              <input type="radio" name="c_${i}"
                ${q.correct_answer === l ? "checked" : ""}
                onclick="ALL_QUESTIONS[${i}].correct_answer='${l}'">
            </span>
          </div>
        `).join("")}
      </div>
    `;
  });
}


function saveQuiz() {
  if (!quizTitle.value.trim()) {
    alert("Quiz title is required");
    return;
  }

  const payload = {
    title: quizTitle.value,
    quiz_mode: QUIZ_MODE,
    scope: QUIZ_SCOPE,
    question_source: document.getElementById("question_source").value
  };
  
  if (ALL_QUESTIONS.length > 0) {
    payload.questions = ALL_QUESTIONS;
  }
  fetch(`/accounts/instructor/course/${COURSE_ID}/quiz/${QUIZ_ID}/save/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrfToken.value
    },
    body: JSON.stringify(payload)
  })
  .then(res => {
    console.log("SAVE STATUS:", res.status);
    if (!res.ok) throw new Error("Save failed");
    return res.json();
  })
  .then(data => {
    console.log("SAVE RESPONSE:", data);
    alert("Quiz saved ‚úî");
  })
  .catch(err => {
    console.error("SAVE ERROR:", err);
    alert("Save failed ‚ùå");
  });
}
</script>
<script src="{% static 'js/add_quiz.js' %}"></script>
</body>
</html>
