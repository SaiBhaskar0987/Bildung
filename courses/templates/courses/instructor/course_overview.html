<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Overview</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center p-3 bg-white shadow-sm">
        <a href="{% url 'instructor:instructor_dashboard' %}" class="text-decoration-none text-dark">
            <h3 class="m-0 fw-bold">Bildung</h3>
        </a>

        <div class="dropdown">
            <button class="btn rounded-circle shadow"
                style="background:gray;color:white;width:45px;height:45px;" type="button"
                data-bs-toggle="dropdown">
                {{ request.user.username|first|upper }}
            </button>

            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="{% url 'instructor_profile_view' %}">Profile</a></li>
                <li><a class="dropdown-item" href="{% url 'instructor:add_course' %}">Create New Course</a></li>
                <li><a class="dropdown-item" href="{% url 'instructor:my_activity' %}">My Activity</a></li>
                <li><a class="dropdown-item" href="{% url 'instructor:students_list' %}">My Students</a></li>
                <li><a class="dropdown-item" href="{% url 'instructor:calendar_view' %}">My Schedules</a></li>
                <li><a class="dropdown-item" href="{% url 'instructor:instructor_notifications' %}">Notifications</a></li>
                <li><a class="dropdown-item" href="#">Earnings & Payments</a></li>
                <li><a class="dropdown-item" href="#">Help & Support</a></li>
                <li><a class="dropdown-item" href="{% url 'instructor:account_settings' %}">Account Settings</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="{% url 'logout_view' %}">Logout</a></li>
            </ul>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <div class="container py-3">

        <h2 class="text-primary mb-4">ğŸ“Š Course Overview â€” {{ course.title }}</h2>

        <div class="btn-group mb-4" role="group">
           <button class="btn btn-outline-primary" data-section="progress">ğŸ“ˆ Progress</button>
           <button class="btn btn-outline-success" data-section="completed">ğŸ“ Completed Students</button>
           <button class="btn btn-outline-info" data-section="downloaded">ğŸ“¥ Certificate Downloaded</button>
           <button class="btn btn-outline-dark" data-section="questions">â“ Questions Asked</button>
           <button class="btn btn-outline-info" data-section="reviews">â­ Reviews</button>

        </div>


        <div id="progress" class="review-section">
            <h4 class="fw-bold mb-3 text-primary">ğŸ“ˆ Student Progress</h4>

            <table class="table table-bordered">
                <thead class="table-primary">
                    <tr>
                        <th>Student</th>
                        <th>Completed</th>
                        <th>Total</th>
                        <th>Progress %</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in progress_list %}
                    <tr>
                        <td>{{ p.student.get_full_name }}</td>
                        <td>{{ p.completed }}</td>
                        <td>{{ p.total }}</td>
                        <td><strong>{{ p.percent }}%</strong></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>


        <div id="completed" class="review-section d-none">
            <h4 class="fw-bold mb-3 text-success">ğŸ“ Students Who Completed the Course</h4>

            {% if completed_students %}
            <table class="table table-bordered">
                <thead class="table-success">
                    <tr>
                        <th>Student</th>
                        <th>Completed On</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in completed_students %}
                    <tr>
                        <td>{{ c.student.get_full_name }}</td>
                        <td>{{ c.issued_on|date:"M d, Y" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-muted">No students have completed this course yet.</p>
            {% endif %}
        </div>


        <div id="downloaded" class="review-section d-none">
            <h4 class="fw-bold mb-3 text-info">ğŸ“¥ Certificate Downloaded</h4>

            {% if downloaded_students %}
            <table class="table table-bordered">
                <thead class="table-info">
                    <tr>
                        <th>Student</th>
                        <th>Downloaded On</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in downloaded_students %}
                    <tr>
                        <td>{{ c.student.get_full_name }}</td>
                        <td>{{ c.downloaded_at|date:"M d, Y H:i" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="text-muted">No certificates have been downloaded yet.</p>
            {% endif %}
        </div>


        <div id="questions" class="review-section d-none">
            <h4 class="fw-bold mb-3 text-dark">â“ Questions Asked</h4>

            {% if questions %}
                {% for q in questions %}
                <div class="card shadow-sm border-0 mb-4 rounded-4">
                    <div class="card-body">

                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="mb-0">â“ {{ q.question }}</h5>

                            <span class="badge bg-info text-dark fw-semibold ms-3">
                                ğŸ¥ {{ q.lecture.title }}
                            </span>
                        </div>

                        <p class="text-muted mb-1">
                            Asked by:
                            <strong>{{ q.student.get_full_name|default:q.student.username }}</strong>
                        </p>
                        <small class="text-muted">
                            {{ q.created_at|date:"M d, Y â€” H:i A" }}
                        </small>

                        <div class="mt-4 ps-3 border-start border-3">

                            {% for r in q.replies.all %}
                            <div class="mb-4">

                                <div class="d-flex justify-content-between">
                                    <div>
                                        <strong>ğŸ’¬ {{ r.user.get_full_name|default:r.user.username }}</strong>

                                        {% if r.user == course.instructor %}
                                        <span class="badge bg-primary ms-2">Instructor</span>
                                        {% endif %}
                                    </div>

                                    {% if r.user == request.user %}
                                    <div class="d-flex gap-2">
                                        <a href="{% url 'instructor:edit_reply' r.id %}?tab=questions" 
                                              class="btn btn-sm btn-outline-primary">Edit</a>

                                        <a href="{% url 'instructor:delete_reply' r.id %}?tab=questions" 
                                            class="btn btn-sm btn-outline-danger"
                                             onclick="return confirm('Delete this reply?');">Delete</a>
                                    </div>
                                    {% endif %}
                                </div>

                                <p class="mt-2 mb-1">{{ r.reply }}</p>
                                <small class="text-muted">
                                    {{ r.created_at|date:"M d, Y â€” H:i A" }}
                                </small>

                            </div>
                            {% empty %}
                            {% endfor %}
                        </div>

                        {% if not q.replies.all %}
                        <form method="POST" action="{% url 'instructor:add_reply' q.id %}?tab=questions" class="mt-3">
                            {% csrf_token %}
                            <div class="input-group">
                                <input name="reply"
                                       class="form-control"
                                       placeholder="Reply to this question..."
                                       required>
                                <button class="btn btn-primary">Reply</button>
                            </div>
                        </form>
                        {% endif %}

                    </div>
                </div>
                {% endfor %}
            {% else %}
            <p class="text-muted">No questions asked yet.</p>
            {% endif %}
        </div>

<div id="reviews" class="review-section d-none">
    <h4 class="fw-bold mb-3 ">â­ Course Reviews</h4>

    {% if reviews %}
        {% for r in reviews %}
        <div class="card shadow-sm border-0 mb-3 rounded-4">
    <div class="card-body">

        <div class="mb-2">
            {% for i in "12345"|make_list %}
                {% if forloop.counter <= r.rating %}
                    <span style="color:#ffc107; font-size:1.3rem;">â˜…</span>
                {% else %}
                    <span style="color:#ccc; font-size:1.3rem;">â˜…</span>
                {% endif %}
            {% endfor %}
        </div>

        <p class="mb-1">{{ r.comment }}</p>

        <small class="text-muted">
            â€” {{ r.student.get_full_name|default:r.student.username }}
            | {{ r.created_at|date:"M d, Y â€” H:i A" }}
        </small>

    </div>
</div>

        {% endfor %}
    {% else %}
        <p class="text-muted">No reviews yet.</p>
    {% endif %}
</div>

    </div>

    <script>
    function activateTab(sectionId) {
        document.querySelectorAll(".review-section")
            .forEach(sec => sec.classList.add("d-none"));

        const activeSection = document.getElementById(sectionId);
        if (activeSection) {
            activeSection.classList.remove("d-none");
        }

        document.querySelectorAll(".btn-group .btn")
            .forEach(btn => {
                btn.classList.toggle("active", btn.dataset.section === sectionId);
            });

        try {
            localStorage.setItem("courseReviewTab", sectionId);
        } catch (e) {
            
        }
    }

    document.querySelectorAll(".btn-group .btn").forEach(btn => {
        btn.addEventListener("click", () => {
            activateTab(btn.dataset.section);
        });
    });

    (function () {
        const params = new URLSearchParams(window.location.search);
        const tabFromUrl = params.get("tab");

        let initialTab = "progress"; 

        if (tabFromUrl) {
            initialTab = tabFromUrl;
        } else {
            try {
                const saved = localStorage.getItem("courseReviewTab");
                if (saved) initialTab = saved;
            } catch (e) {
            }
        }

        activateTab(initialTab);
    })();
    </script>

</body>
</html>
