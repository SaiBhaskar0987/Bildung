{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit Course</title>

    <link rel="stylesheet" href="{% static 'css/add_course.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <script>
        const BASE_URL = "/accounts/instructor";
        const COURSE_ID = "{{ course.id }}";
    </script>

<style>

.topbar {
    background: white;
    padding: 12px 25px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.topbar-title {
    font-size: 26px;
    font-weight: 700;
    text-decoration: none;
    color: #222;
}

#topRow {
    display: flex;
    flex-wrap: wrap;
    gap: 18px;
    margin-top: 30px;
    justify-content: center;
}

.builder-card {
    width: 230px;
    height: 170px;
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.12);
    padding: 15px;
    cursor: grab;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    border: 3px dashed transparent;
}

.card-title {
    font-size: 18px;
    font-weight: 700;
    text-align: center;
}

.card-actions {
    display: flex;
    justify-content: center;
    gap: 10px;
}

.open-module-btn {
    background: #4caf50;
    color: white;
    border-radius: 6px;
    border: none;
    padding: 6px 12px;
    font-size: 13px;
}

.delete-module-btn {
    background: #ff3d3d;
    color: white;
    border-radius: 6px;
    border: none;
    padding: 6px 12px;
    font-size: 13px;
}

.module-card { border-color: #6aa9ff; }
.quiz-card { border-color: #ffc466; }
.assignment-card { border-color: #8df2a1; }
.liveclass-card { border-color: #ffa7d1; }

.drop-zone {
    width: 230px;
    height: 170px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 42px;
    background: #f7f9ff;
    border: 3px dashed #aab4d4;
    border-radius: 14px;
    cursor: pointer;
}
.bottom-area {
    margin-top: 30px;   
}

.drag-row {
    margin-top: 25px;   
    display: flex;
    gap: 14px;
    justify-content: center;
}
</style>
</head>

<body class="bg-light">

<div class="topbar">
    <a href="{% url 'instructor_dashboard' %}" class="topbar-title">Bildung</a>

    <div class="dropdown">
        <button class="btn rounded-circle shadow"
                style="background:#666;color:white;width:45px;height:45px;"
                data-bs-toggle="dropdown">
            {{ request.user.username|first|upper }}
        </button>

        <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="{% url 'instructor_profile_view' %}">Profile</a></li>
                <li><a class="dropdown-item" href="{% url 'instructor:add_course' %}">Create New Course</a></li>
                <li><a class="dropdown-item" href="{% url 'instructor:students_list' %}">My Students</a></li>
                <li><a class="dropdown-item" href="{% url 'instructor:calendar_view' %}">My Schedules</a></li>
                <li><a class="dropdown-item" href="{% url 'instructor_notifications' %}">Notifications</a></li>
                <li><a class="dropdown-item" href="#">Earnings & Payments</a></li>
                <li><a class="dropdown-item" href="#">Help & Support</a></li>
                <li><a class="dropdown-item" href="{% url 'instructor_account_settings' %}">Account Settings</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="{% url 'logout_view' %}">Logout</a></li>
        </ul>
    </div>
</div>

<div class="paper">

    <h1 class="title">EDIT COURSE</h1>

    <label class="label">Course Title</label>
    <input id="courseTitle" class="input-box" value="{{ course.title }}">

    <label class="label">Description</label>
    <textarea id="courseDescription" class="input-box">{{ course.description }}</textarea>

    <label class="label">Price (â‚¹)</label>
    <input id="coursePrice" type="number" class="input-box" value="{{ course.price }}">

    <label class="label">Category</label>
    <select id="courseCategory" class="input-box">
        <option value="business" {% if course.category == 'business' %}selected{% endif %}>Business</option>
        <option value="design" {% if course.category == 'design' %}selected{% endif %}>Design</option>
        <option value="music" {% if course.category == 'music' %}selected{% endif %}>Music</option>
        <option value="programming" {% if course.category == 'programming' %}selected{% endif %}>Programming</option>
        <option value="others" {% if course.category == 'others' %}selected{% endif %}>Others</option>
    </select>
    
    <label class="label">Course Level</label>
    <select id="courseLevel" class="input-box">
        <option value="beginner" {% if course.level == "beginner" %}selected{% endif %}>
          Beginner
       </option>
       <option value="intermediate" {% if course.level == "intermediate" %}selected{% endif %}>
          Intermediate
       </option>
      <option value="advanced" {% if course.level == "advanced" %}selected{% endif %}>
          Advanced
      </option>
    </select>

    <hr class="divider">

    <h1 class="title">MODULE BUILDER</h1>

    <div id="topRow">
        {% for block in course.structure_json %}
        <div class="builder-card
            {% if block.type == 'Module' %}module-card{% endif %}
            {% if block.type == 'Quiz' %}quiz-card{% endif %}
            {% if block.type == 'Assignment' %}assignment-card{% endif %}
            {% if block.type == 'Live Class' %}liveclass-card{% endif %}"
            draggable="true"
            data-type="{{ block.type }}"
            data-module-id="{{ block.module_id|default:'' }}"
            data-quiz-id="{{ block.quiz_id|default:'' }}"
            data-assignment-id="{{ block.assignment_id|default:'' }}"
            data-liveclass-id="{{ block.liveclass_id|default:'' }}"
            data-lectures='{{ block.lectures|default:"[]"|safe }}'>

            <div class="card-title">{{ block.title }}</div>

            <div class="card-actions">
                {% if block.type == "Module" %}
                <button class="open-module-btn"
                        onclick="openModule({{ forloop.counter0 }})">
                    Edit
                </button>
                {% endif %}

                {% if block.type == "Quiz" %}
                <button class="open-module-btn"
                        onclick="openQuiz({{ forloop.counter0 }})">
                    Edit
                </button>
                {% endif %}

                <button class="delete-module-btn"
                        onclick="deleteBlock({{ forloop.counter0 }})">
                    âœ–
                </button>
            </div>
        </div>
        {% endfor %}

        <div id="dropZone" class="drop-zone">+</div>
    </div>

    <div class="bottom-area">
        <div class="drag-row">
            <div class="draggable-btn module-btn" draggable="true" data-type="Module">Module</div>
            <div class="draggable-btn quiz-btn" draggable="true" data-type="Quiz">Quiz</div>
            <div class="draggable-btn assignment-btn" draggable="true" data-type="Assignment">Assignment</div>
            <div class="draggable-btn liveclass-btn" draggable="true" data-type="Live Class">Live Class</div>
        </div>

        <div class="actions">
            <button class="save-main" onclick="saveCourse()">Save Changes</button>
            <button class="publish-main" onclick="publishCourse()">Publish</button>
        </div>

        <div class="note">ðŸ’¡ Drag items onto the + box to add them</div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>let structure = [];
let courseId = COURSE_ID;
let dragType = null;

document.addEventListener("DOMContentLoaded", () => {
    loadExistingStructure();
    renderStructure();
});


function loadExistingStructure() {
    structure = [];

    document.querySelectorAll(".builder-card").forEach(card => {
        structure.push({
            type: card.dataset.type,
            title: card.dataset.title || "",
            description: card.dataset.description || "",
            module_id: card.dataset.moduleId || null,
            quiz_id: card.dataset.quizId || null,
            assignment_id: card.dataset.assignmentId || null,
            liveclass_id: card.dataset.liveclassId || null,
            lectures: card.dataset.lectures
                ? JSON.parse(card.dataset.lectures)
                : []
        });
    });
}

function renderStructure() {
    const row = document.getElementById("topRow");
    row.innerHTML = "";

    let m = 1, q = 1, a = 1, l = 1;

    structure.forEach((item, index) => {
        if (item.type === "Module") item.title = `Module ${m++}`;
        if (item.type === "Quiz") item.title = `Quiz ${q++}`;
        if (item.type === "Assignment") item.title = `Assignment ${a++}`;
        if (item.type === "Live Class") item.title = `Live Class ${l++}`;

        row.insertAdjacentHTML("beforeend", generateCardHTML(item, index));
    });

    row.insertAdjacentHTML(
        "beforeend",
        `<div id="dropZone" class="drop-zone">+</div>`
    );

    enableReorder();
    enableAddDrop();
}

function generateCardHTML(item, index) {
    return `
        <div class="builder-card
            ${item.type === "Module" ? "module-card" : ""}
            ${item.type === "Quiz" ? "quiz-card" : ""}
            ${item.type === "Assignment" ? "assignment-card" : ""}
            ${item.type === "Live Class" ? "liveclass-card" : ""}
        " draggable="true" data-index="${index}">

            <div class="card-title">${item.title}</div>

            <div class="card-actions">
                ${
                    item.type === "Module"
                        ? `<button class="open-module-btn" onclick="openModule(${index})">Edit</button>`
                        : ""
                }

                ${
                    item.type === "Quiz"
                        ? `<button class="open-module-btn" onclick="openQuiz(${index})">Edit</button>`
                        : ""
                }

                <button class="delete-module-btn" onclick="deleteBlock(${index})">âœ–</button>
            </div>
        </div>
    `;
}

function enableAddDrop() {
    const dropZone = document.getElementById("dropZone");

    document.querySelectorAll(".draggable-btn").forEach(btn => {
        btn.addEventListener("dragstart", () => dragType = btn.dataset.type);
        btn.addEventListener("dragend", () => dragType = null);
    });

    dropZone.addEventListener("dragover", e => e.preventDefault());

    dropZone.addEventListener("drop", () => {
        if (!dragType) return;

        structure.push({
            type: dragType,
            title: "",
            description: "",
            module_id: null,
            quiz_id: null,
            assignment_id: null,
            liveclass_id: null,
            lectures: []
        });

        renderStructure();
    });
}


function enableReorder() {
    document.querySelectorAll(".builder-card").forEach(card => {
        card.addEventListener("dragstart", e => {
            e.dataTransfer.setData("oldIndex", card.dataset.index);
        });

        card.addEventListener("dragover", e => e.preventDefault());

        card.addEventListener("drop", e => {
            e.preventDefault();

            const oldIndex = Number(e.dataTransfer.getData("oldIndex"));
            const newIndex = Number(card.dataset.index);

            if (oldIndex === newIndex) return;

            const moved = structure.splice(oldIndex, 1)[0];
            structure.splice(newIndex, 0, moved);

            renderStructure();
        });
    });
}

function openModule(index) {
    const item = structure[index];

    if (!item.module_id) {
        fetch(`${BASE_URL}/module/create/`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ course_id: courseId })
        })
        .then(r => r.json())
        .then(data => {
            structure[index].module_id = data.module_id;
            saveCourse(() => {
                window.location.href =
                    `${BASE_URL}/courses/${courseId}/module/${data.module_id}/edit/`;
            });
        });
        return;
    }

    saveCourse(() => {
        window.location.href =
            `${BASE_URL}/courses/${courseId}/module/${item.module_id}/edit/`;
    });
}

function openQuiz(index) {
    const item = structure[index];

    saveCourse(() => {
        if (!item.quiz_id) {
            alert("Quiz not created yet. Save once more.");
            return;
        }

        window.location.href =
            `${BASE_URL}/course/${courseId}/quiz/${item.quiz_id}/edit/`;
    });
}

function deleteBlock(index) {
    if (!confirm("Delete this item?")) return;

    structure.splice(index, 1);
    renderStructure();
}


function saveCourse(callback = null) {
    const payload = {
        course_id: courseId,
        title: document.getElementById("courseTitle").value,
        description: document.getElementById("courseDescription").value,
        price: document.getElementById("coursePrice").value,
        category: document.getElementById("courseCategory").value,
        structure: structure
    };

    fetch(`/accounts/instructor/save/`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        courseId = data.course_id;
        structure = data.structure;

        if (callback) callback();
        else alert("Course Saved!");
    });
}

function publishCourse() {
    if (!courseId) {
        alert("Please save first!");
        return;
    }

    saveCourse(() => {
        window.location.href = `${BASE_URL}/publish/${courseId}/`;
    });
}
</script>
</body>
</html>
